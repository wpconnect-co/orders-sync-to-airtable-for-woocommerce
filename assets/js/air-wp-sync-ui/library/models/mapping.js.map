{"version":3,"file":"mapping.js","sources":["../../src/models/mapping/MappingManager.ts"],"sourcesContent":["import { arrayMoveImmutable } from 'array-move';\nimport { v4 as uuidv4 } from 'uuid';\nimport {\n\tAirtableField,\n\tMapping,\n\tMappingGroupOptions,\n\tMappingOption, AirtableSelectFieldGroupOption, AirtableSelectFieldGroupOptions,\n\tSetMappingSignature,\n\tSupportedSource, WordPressSelectFieldGroupOptions\n} from \"./Mapping.types\";\nimport {getAirtableFieldById} from \"./helpers\";\n\nexport default class MappingManager {\n\n\n\tfields:AirtableField[]\n\tsetMapping:SetMappingSignature\n\n\tmapping: Mapping[]\n\tallSupportedAirtableTypes: SupportedSource[]\n\tprivate _airtableSelectFieldGroupsOptions:AirtableSelectFieldGroupOptions\n\tprivate _wordPressSelectFieldsOptions:WordPressSelectFieldGroupOptions[]\n\tindexedWordPressFields: Record<string, MappingOption>\n\tindexedAirtablesFields: Record<string, AirtableField>\n\n\tconstructor(mappingInit:Mapping[], setMapping:SetMappingSignature, fields:AirtableField[], defaultMappingOptions:MappingGroupOptions, isOptionAvailable:(featurePath:string) => boolean) {\n\t\tconst self = this;\n\n\t\tthis.fields = fields;\n\t\tthis.setMapping = setMapping;\n\n\t\tthis.mapping = mappingInit.map((m) => {\n\t\t\tif (m.key) {\n\t\t\t\treturn m;\n\t\t\t}\n\t\t\treturn { ...m, key: uuidv4() } as Mapping;\n\t\t});\n\n\t\tthis.allSupportedAirtableTypes = Object.keys(defaultMappingOptions).reduce((result, groupName) => {\n\t\t\tresult = result.concat(defaultMappingOptions[groupName].options.reduce<string[]>((supported_sources, option) => {\n\t\t\t\tsupported_sources = supported_sources.concat(option.supported_sources);\n\t\t\t\treturn supported_sources;\n\t\t\t}, []));\n\t\t\treturn result;\n\t\t}, [] as string[]);\n\n\t\tthis._airtableSelectFieldGroupsOptions = fields.reduce(function (result, field) {\n\t\t\tif (self.allSupportedAirtableTypes.indexOf(field.type) === -1) {\n\t\t\t\treturn result;\n\t\t\t}\n\t\t\tconst group = field.group;\n\t\t\tif (!( group in result )) {\n\t\t\t\tresult[group] = {\n\t\t\t\t\tlabel: group,\n\t\t\t\t\toptions: []\n\t\t\t\t} as AirtableSelectFieldGroupOption;\n\t\t\t}\n\n\t\t\tresult[group].options.push(field);\n\t\t\treturn result;\n\t\t}, {} as AirtableSelectFieldGroupOptions);\n\n\t\tthis._wordPressSelectFieldsOptions = this.mapping.map((field) => {\n\t\t\tconst mappingOptions = {} as WordPressSelectFieldGroupOptions;\n\t\t\tconst airtableField = getAirtableFieldById(field.airtable, fields);\n\n\t\t\t// Filter options by post type\n\t\t\tfor (const groupName in defaultMappingOptions) {\n\t\t\t\tconst group = defaultMappingOptions[groupName];\n\t\t\t\tconst groupOptions = group.options.filter(function(option) {\n\t\t\t\t\treturn isOptionAvailable(option.value);\n\t\t\t\t});\n\t\t\t\tif (groupOptions.length > 0) {\n\t\t\t\t\tmappingOptions[groupName] = { ...group, options: groupOptions };\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Filter options by supported types\n\t\t\tlet airtableType = airtableField ? airtableField.type : '';\n\t\t\tfor (const groupName in mappingOptions) {\n\t\t\t\tconst group = mappingOptions[groupName];\n\t\t\t\tgroup.options = group.options.filter(function(option) {\n\t\t\t\t\treturn option.supported_sources.indexOf(airtableType) > -1\n\t\t\t\t});\n\t\t\t\tif (group.options.length === 0) {\n\t\t\t\t\tdelete mappingOptions[groupName];\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tconst rowValue = field.wordpress ?? null;\n\n\t\t\t// Check if some options must be disabled\n\t\t\tfor (const groupName in mappingOptions) {\n\t\t\t\tconst group = mappingOptions[groupName];\n\t\t\t\tgroup.options = group.options.map(function(option) {\n\t\t\t\t\treturn {\n\t\t\t\t\t\t...option,\n\t\t\t\t\t\tenabled: option.enabled && (option.value === rowValue || !self.isOptionDisabled(option))\n\t\t\t\t\t};\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn mappingOptions;\n\t\t});\n\n\t\tthis.indexedWordPressFields = Object.keys(defaultMappingOptions).reduce(function (result, groupName) {\n\t\t\tdefaultMappingOptions[groupName].options.forEach((field) => {\n\t\t\t\tresult[field.value] = field;\n\t\t\t}, []);\n\t\t\treturn result\n\t\t}, {} as Record<string, MappingOption>);\n\n\t\tthis.indexedAirtablesFields = fields.reduce(function (result, airtableField) {\n\t\t\tresult[airtableField.id] = airtableField;\n\t\t\treturn result\n\t\t}, {} as Record<string, AirtableField>);\n\t}\n\n\tisOptionDisabled(option:MappingOption) {\n\t\tif (option.allow_multiple) {\n\t\t\treturn false;\n\t\t}\n\t\treturn this.mapping.reduce(function(result, current) {\n\t\t\treturn current.wordpress && current.wordpress === option.value ? true : result;\n\t\t}, false);\n\t}\n\n\n\tgetAirtableFirstOption() {\n\t\treturn this.fields.length > 0 ? this.fields[0].id : '';\n\t}\n\n\taddMappingRow() {\n\t\tconst airtableFirstOption = this.getAirtableFirstOption();\n\n\t\tthis.setMapping([\n\t\t\t...this.mapping,\n\t\t\t{\n\t\t\t\tairtable: airtableFirstOption,\n\t\t\t\twordpress: '',\n\t\t\t\toptions: {},\n\t\t\t\tkey: uuidv4()\n\t\t\t} as Mapping\n\t\t]);\n\t};\n\n\tupdateAirtableField(index:number, airtableFieldId:string) {\n\t\tthis.setMapping(this.mapping.map((el, i) => {\n\t\t\tif (i === index) {\n\t\t\t\treturn {\n\t\t\t\t\t...el,\n\t\t\t\t\tairtable: airtableFieldId\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn el;\n\t\t}));\n\t};\n\tupdateWordPressField(index:number, wordPressFieldId:string) {\n\t\tthis.setMapping(this.mapping.map((el, i) => {\n\t\t\tif (i === index) {\n\t\t\t\treturn {\n\t\t\t\t\t...el,\n\t\t\t\t\twordpress: wordPressFieldId\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn el;\n\t\t}));\n\t};\n\tupdateFieldOption(index:number, optionName:string, optionValue:any) {\n\t\tthis.setMapping(this.mapping.map((el, i) => {\n\t\t\tif (i === index) {\n\t\t\t\treturn {\n\t\t\t\t\t...el,\n\t\t\t\t\toptions: {\n\t\t\t\t\t\t...el.options,\n\t\t\t\t\t\t[optionName]: optionValue\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t}\n\t\t\treturn el;\n\t\t}));\n\t};\n\tremoveMappingRow(index:number) {\n\t\tthis.setMapping(this.mapping.filter((el, i) => i !== index));\n\t};\n\n\tmoveMappingRow(oldIndex:number, newIndex:number) {\n\t\tthis.setMapping( arrayMoveImmutable(this.mapping, oldIndex, newIndex) );\n\t};\n\n\n\tgetWordPressFieldById(wordPressFieldId:string) {\n\t\treturn this.indexedWordPressFields[wordPressFieldId]\n\t};\n\n\tgetAirtableFieldById(airtableFieldId:string) {\n\t\treturn this.indexedAirtablesFields[airtableFieldId]\n\t};\n\n\n\tget airtableSelectFieldGroupsOptions(): AirtableSelectFieldGroupOptions {\n\t\treturn this._airtableSelectFieldGroupsOptions;\n\t}\n\n\tget wordPressSelectFieldsOptions(): WordPressSelectFieldGroupOptions[] {\n\t\treturn this._wordPressSelectFieldsOptions;\n\t}\n\n}\n"],"names":["uuidv4"],"mappings":"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"}